@{
    ViewData["Title"] = "高德地图代理测试";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>@ViewData["Title"]</title>
    <style>
        body, html, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 400px;
        }
        .info-panel h3 {
            margin-top: 0;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .btn {
            padding: 8px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        .btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="info-panel">
        <h3>高德地图代理测试</h3>
        <div id="status" class="status">正在加载地图...</div>
        <div>
            <button class="btn" onclick="testProxy()">测试代理</button>
            <button class="btn" onclick="testGeocoding()">测试地理编码</button>
        </div>
        <div id="result" style="margin-top: 10px;"></div>
    </div>
    
    <div id="container"></div>
    
    <!-- 使用代理方式加载高德地图 JS API -->
    <script src="/amap/proxy?v=2.0&key=YOUR_AMAP_KEY"></script>
    <script>
        var map;
        var statusDiv = document.getElementById('status');
        var resultDiv = document.getElementById('result');

        // 初始化地图
        function initMap() {
            try {
                // 检查 AMap 是否加载成功
                if (typeof AMap === 'undefined') {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = '❌ 地图加载失败：AMap 对象未定义';
                    return;
                }

                map = new AMap.Map('container', {
                    zoom: 13,
                    center: [116.397428, 39.90923], // 北京天安门
                    viewMode: '3D',
                    pitch: 45
                });

                // 添加标记
                var marker = new AMap.Marker({
                    position: [116.397428, 39.90923],
                    title: '北京天安门'
                });
                map.add(marker);

                statusDiv.className = 'status success';
                statusDiv.innerHTML = '✅ 地图加载成功！代理方式工作正常。';

                // 添加地图事件
                map.on('complete', function() {
                    console.log('地图加载完成');
                });

                map.on('click', function(e) {
                    resultDiv.innerHTML = `点击位置: 经度 ${e.lnglat.getLng()}, 纬度 ${e.lnglat.getLat()}`;
                });

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '❌ 地图初始化失败：' + error.message;
                console.error('地图初始化错误:', error);
            }
        }

        // 测试代理
        function testProxy() {
            resultDiv.innerHTML = '<p>正在测试代理...</p>';
            
            fetch('/amap/proxy?v=2.0&key=YOUR_AMAP_KEY')
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('代理请求失败：' + response.status);
                })
                .then(data => {
                    resultDiv.innerHTML = `<p style="color: green;">✅ 代理测试成功</p><p>响应长度: ${data.length} 字符</p>`;
                })
                .catch(error => {
                    resultDiv.innerHTML = `<p style="color: red;">❌ 代理测试失败：${error.message}</p>`;
                });
        }

        // 测试地理编码 API
        function testGeocoding() {
            resultDiv.innerHTML = '<p>正在测试地理编码 API...</p>';
            
            fetch('/amap/api/v3/geocode/geo?address=北京市朝阳区阜通东大街6号&key=YOUR_AMAP_KEY')
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1') {
                        var location = data.geocodes[0].location;
                        resultDiv.innerHTML = `<p style="color: green;">✅ 地理编码测试成功</p><p>地址: 北京市朝阳区阜通东大街6号</p><p>坐标: ${location}</p>`;
                        
                        // 在地图上标记
                        if (map) {
                            var coords = location.split(',');
                            map.setCenter([parseFloat(coords[0]), parseFloat(coords[1])]);
                            var marker = new AMap.Marker({
                                position: [parseFloat(coords[0]), parseFloat(coords[1])],
                                title: '搜索结果'
                            });
                            map.add(marker);
                        }
                    } else {
                        resultDiv.innerHTML = `<p style="color: red;">❌ 地理编码失败：${data.info}</p>`;
                    }
                })
                .catch(error => {
                    resultDiv.innerHTML = `<p style="color: red;">❌ 请求失败：${error.message}</p>`;
                });
        }

        // 页面加载完成后初始化地图
        window.onload = function() {
            // 延迟初始化，确保 AMap 已加载
            setTimeout(initMap, 500);
        };
    </script>
</body>
</html>
